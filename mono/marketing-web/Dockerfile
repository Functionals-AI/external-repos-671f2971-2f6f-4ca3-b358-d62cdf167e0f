ARG BUILD_TYPE

FROM node:22-alpine as dependencies

ENV NEXT_TELEMETRY_DISABLED 1
RUN mkdir -p /app
WORKDIR /app
RUN npm install -g pnpm@10.4.1
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY ./marketing-web/package.json ./marketing-web/package.json
RUN pnpm install --frozen-lockfile --loglevel notice

###

FROM node:22-alpine as pre-build

ARG NEXT_PUBLIC_VERSION
ARG NODE_ENV
ARG NEXT_PUBLIC_GA_MEASUREMENT_ID
ARG PLASMIC_PROJECT_ID
ARG PLASMIC_TOKEN
ARG PLASMIC_CMS_ID
ARG PLASMIC_CMS_PUBLIC_KEY
ARG PLASMIC_CMS_SECRET_KEY
ARG TELENUTRITION_API_BASEURL

ENV NODE_ENV=$NODE_ENV
ENV NEXT_TELEMETRY_DISABLED 1
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_GA_MEASUREMENT_ID=$NEXT_PUBLIC_GA_MEASUREMENT_ID
ENV PLASMIC_PROJECT_ID=$PLASMIC_PROJECT_ID
ENV PLASMIC_TOKEN=$PLASMIC_TOKEN
ENV PLASMIC_CMS_ID=$PLASMIC_CMS_ID
ENV PLASMIC_CMS_PUBLIC_KEY=$PLASMIC_CMS_PUBLIC_KEY
ENV PLASMIC_CMS_SECRET_KEY=$PLASMIC_CMS_SECRET_KEY
ENV TELENUTRITION_API_BASEURL=$TELENUTRITION_API_BASEURL

WORKDIR /app
RUN echo "$NEXT_PUBLIC_API_BASE_URL"
RUN echo "$NEXT_PUBLIC_VERSION"
RUN echo "$NODE_ENV"
RUN echo "$NEXT_PUBLIC_GA_MEASUREMENT_ID"
RUN echo "$PLASMIC_CMS_ID"
RUN echo "$PLASMIC_CMS_PUBLIC_KEY"
RUN echo "$PLASMIC_CMS_SECRET_KEY"
RUN echo "$TELENUTRITION_API_BASEURL"
COPY --from=dependencies /app/node_modules ./node_modules
COPY --from=dependencies /app/marketing-web/node_modules ./marketing-web/node_modules
COPY ./marketing-web ./marketing-web
WORKDIR /app/marketing-web
RUN echo -e "PLASMIC_PROJECT_ID=$PLASMIC_PROJECT_ID\nPLASMIC_TOKEN=$PLASMIC_TOKEN\nNEXT_PUBLIC_GA_MEASUREMENT_ID=$NEXT_PUBLIC_GA_MEASUREMENT_ID\TELENUTRITION_API_BASEURL=$TELENUTRITION_API_BASEURL" > .env.local

FROM pre-build as build-dev

FROM pre-build as build-prod
RUN pnpm run build

FROM build-${BUILD_TYPE} as final
RUN chown -R node:node /app
USER node
EXPOSE 8081
